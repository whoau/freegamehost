name: GTXGaming Auto Extend

on:
  workflow_dispatch:
  schedule:
    - cron: "10 2 * * *"  # 每天 02:10 UTC 运行，按需修改

permissions:
  contents: write  # 允许推送 md 更新

concurrency:
  group: gtxgaming-extend-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Restore cookies cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .cache/cookies.json
          key: gtx-cookies-v1-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            gtx-cookies-v1-${{ runner.os }}-

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Playwright + deps
        run: |
          python -m pip install --upgrade pip
          pip install playwright pyotp
          playwright install --with-deps chromium

      - name: Run auto extend
        env:
          GTX_EMAIL: ${{ secrets.GTX_EMAIL }}
          GTX_PASSWORD: ${{ secrets.GTX_PASSWORD }}
          GTX_TOTP_SECRET: ${{ secrets.GTX_TOTP_SECRET }}          # 可选：2FA TOTP 秘钥
          GTX_BASE_URL: https://gamepanel2.gtxgaming.co.uk
          GTX_LOGIN_PATH: /auth/login
          GTX_COOKIE_PATH: .cache/cookies.json
          GTX_SERVER_URL: ${{ vars.GTX_SERVER_URL }}               # 可选：服务器管理页完整 URL（推荐）
          GTX_SERVER_NAME: ${{ vars.GTX_SERVER_NAME }}             # 可选：按名称匹配
          GTX_SERVER_INDEX: ${{ vars.GTX_SERVER_INDEX || '0' }}    # 可选：多服务器索引
          GTX_HEADLESS: "1"
          GTX_TIMEOUT_MS: "45000"
          GTX_DEBUG: ${{ vars.GTX_DEBUG || '0' }}                  # 设 1 保存截图/HTML
          GTX_COOKIE_HEADER: ${{ secrets.GTX_COOKIE_HEADER }}      # 可选：浏览器 Cookie 请求头
          GTX_COOKIES_B64: ${{ secrets.GTX_COOKIES_B64 }}          # 可选：Base64 cookies.json
          GTX_COOKIE_DOMAIN: gamepanel2.gtxgaming.co.uk
          GTX_STATUS_MD: ${{ vars.GTX_STATUS_MD || 'EXTEND_STATUS.md' }}  # 输出 md 文件
          GTX_TZ: ${{ vars.GTX_TZ || 'Asia/Shanghai' }}                    # 显示时区
          GTX_WRITE_SUMMARY: "1"
        run: |
          mkdir -p .cache .artifacts
          python gtx_auto_extend.py

      - name: Save cookies cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .cache/cookies.json
          key: gtx-cookies-v1-${{ runner.os }}-${{ github.ref_name }}-${{ github.run_id }}

      - name: Commit status markdown
        if: always()
        env:
          STATUS_MD: ${{ vars.GTX_STATUS_MD || 'EXTEND_STATUS.md' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -f "$STATUS_MD" ]; then
            git add "$STATUS_MD"
            if ! git diff --cached --quiet; then
              git commit -m "docs: update extend status at $(date -u '+%Y-%m-%d %H:%M:%S') UTC [skip ci]"
              git push
            else
              echo "No status changes."
            fi
          else
            echo "No status markdown to commit."
          fi

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gtx-debug
          path: .artifacts
          if-no-files-found: ignore
